{"version":3,"file":"use-grindery-login.cjs.development.js","sources":["../src/utils.ts","../src/index.tsx"],"sourcesContent":["declare global {\n  interface Window {\n    _hsq?: any[];\n    LOQ?: any[];\n  }\n}\n\nexport const identifyUserInHubspot = (userId: string, email: string) => {\n  let _hsq = (window._hsq = window._hsq || []);\n  _hsq.push([\n    'identify',\n    {\n      email: email,\n      id: userId,\n    },\n  ]);\n};\n\nexport const identifyUserInLuckyOrange = (userId: string, email: string) => {\n  window.LOQ = window.LOQ || [];\n  window.LOQ.push([\n    'ready',\n    async (LO: any) => {\n      await LO.$internal.ready('visitor');\n      LO.visitor.identify(userId, { email: email });\n    },\n  ]);\n};\n","import React, {\n  useState,\n  createContext,\n  useContext,\n  useEffect,\n  useCallback,\n} from 'react';\nimport { identifyUserInHubspot, identifyUserInLuckyOrange } from './utils';\n\n// Grindery Engine URL\nconst ENGINE_URL = 'https://orchestrator.grindery.com';\n\n// Login page URL\nexport const LOGIN_URL =\n  window.location.hostname.includes('-staging.grindery') ||\n  window.location.hostname.includes('localhost') ||\n  window.location.hostname.includes('127.0.0.1')\n    ? 'https://login-staging.grindery.com'\n    : 'https://login.grindery.com';\n\n// Authentication token object definition\nexport type AuthToken = {\n  access_token: string;\n  expires_in: number;\n  refresh_token?: string;\n  token_type: string;\n};\n\n// Context properties definition\nexport type GrinderyLoginContextProps = {\n  /** Authentication token object */\n  token: AuthToken | null;\n\n  /** User ID */\n  user: string | null;\n\n  /** User address */\n  address: string | null;\n\n  /** User authentication loading state */\n  isAuthenticating: boolean;\n\n  /** Connect user */\n  connect: () => void;\n\n  /** Disconnect user */\n  disconnect: () => void;\n};\n\nexport type GrinderyLoginProviderProps = {\n  children: React.ReactNode;\n  /**\n   * Loader component, visible while user is authenticating\n   */\n  loader?: React.ReactNode;\n  /**\n   * URL to redirect to after user disconnects\n   */\n  disconnectRedirectUrl?: string;\n};\n\n// Default context properties\nconst defaultContext = {\n  token: null,\n  address: null,\n  user: null,\n  isAuthenticating: true,\n  connect: () => {},\n  disconnect: () => {},\n};\n\n/** Grindery Nexus Context */\nexport const GrinderyLoginContext = createContext<GrinderyLoginContextProps>(\n  defaultContext\n);\n\n/**\n * The component provides context for user authentication.\n *\n * It manages authentication state (token, user, address),\n * provides connect and disconnect functionality,\n * and listens for updates from a hidden iframe.\n *\n * It also exposes the context via the useGrinderyLogin hook.\n */\nexport const GrinderyLoginProvider = ({\n  children,\n  loader,\n  disconnectRedirectUrl,\n}: GrinderyLoginProviderProps) => {\n  // Authentication token object\n  const [token, setToken] = useState<AuthToken | null>(null);\n\n  // User ID\n  const [user, setUser] = useState<string | null>(null);\n\n  // User address\n  const [address, setAddress] = useState<string | null>(null);\n\n  // User authentication loading state\n  const [isAuthenticating, setIsAuthenticating] = useState<boolean>(true);\n\n  // Loading state\n  const [loading, setLoading] = React.useState(true);\n\n  // Connect user\n  const connect = async () => {\n    const currentUrl = window.location.href.split('?')[0];\n    window.location.href = `${LOGIN_URL}?redirect_uri=${currentUrl}`;\n  };\n\n  // Disconnect user\n  const disconnect = async () => {\n    // get iframe element\n    const iframe = document.getElementById(\n      'grindery-login-iframe'\n    ) as HTMLIFrameElement;\n\n    // send message to iframe\n    iframe.contentWindow?.postMessage(\n      {\n        method: 'grindery-auth-session-clear',\n      },\n      LOGIN_URL\n    );\n    // clear state\n    setToken(null);\n    setAddress(null);\n    setUser(null);\n\n    // redirect to disconnectRedirectUrl if provided\n    if (disconnectRedirectUrl) {\n      window.location.href = disconnectRedirectUrl;\n    }\n  };\n\n  // Identify user with email in Hubspot and Lucky Orange\n  const identifyUser = useCallback(async () => {\n    if (user && token?.access_token) {\n      try {\n        const rawResponse = await fetch(`${ENGINE_URL}`, {\n          method: 'POST',\n          headers: {\n            Authorization: `Bearer ${token.access_token}`,\n            Accept: 'application/json',\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            jsonrpc: '2.0',\n            id: new Date(),\n            method: 'or_getUserEmail',\n            params: {},\n          }),\n        });\n        const getUserEmailResponse = await rawResponse.json();\n        if (getUserEmailResponse.result) {\n          identifyUserInHubspot(user, getUserEmailResponse.result);\n          identifyUserInLuckyOrange(user, getUserEmailResponse.result);\n        } else {\n          throw new Error('No user email found');\n        }\n      } catch (error) {\n        console.error('identifyUser error: ', error);\n      }\n    }\n  }, [user, token]);\n\n  // Listen for messages from the login iframe\n  useEffect(() => {\n    // handle message\n    function handleMessage(event: any) {\n      if (event.data?.method === 'grindery-auth-session') {\n        // handle error\n        if (event.data?.error) {\n          console.log('grindery-auth-session error: ', event.data?.error);\n        }\n\n        setToken(event.data?.params?.token || null);\n        setAddress(event.data?.params?.address || null);\n        setUser(event.data?.params?.user || null);\n\n        setIsAuthenticating(false);\n      }\n    }\n\n    // add event listener\n    window.addEventListener('message', handleMessage);\n\n    // remove event listener on unmount\n    return () => window.removeEventListener('message', handleMessage);\n  }, []);\n\n  // Identify user on user change\n  useEffect(() => {\n    identifyUser();\n  }, [identifyUser]);\n\n  useEffect(() => {\n    if (loader) {\n      if (!isAuthenticating) {\n        setTimeout(() => {\n          if (token?.access_token) {\n            setLoading(false);\n          } else {\n            connect();\n          }\n        }, 1000);\n      }\n    }\n  }, [token, isAuthenticating, loader, connect]);\n\n  useEffect(() => {\n    if (loader) {\n      if (!token?.access_token) {\n        setLoading(true);\n      }\n    }\n  }, [token, loader]);\n\n  return (\n    <GrinderyLoginContext.Provider\n      value={{\n        token,\n        user,\n        address,\n        isAuthenticating,\n        connect,\n        disconnect,\n      }}\n    >\n      {/* Hidden iframe to handle login session */}\n      <iframe\n        id=\"grindery-login-iframe\"\n        title=\"Grindery Login Session\"\n        src={`${LOGIN_URL}/session`}\n        style={{ display: 'none' }}\n      />\n      {loading && loader ? loader : children}\n    </GrinderyLoginContext.Provider>\n  );\n};\n\n/** Grindery Login Hook */\nexport const useGrinderyLogin = () => useContext(GrinderyLoginContext);\n\nexport default GrinderyLoginProvider;\n"],"names":["identifyUserInHubspot","userId","email","_hsq","window","push","id","identifyUserInLuckyOrange","LOQ","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","LO","wrap","_callee$","_context","prev","next","$internal","ready","visitor","identify","stop","_x","apply","arguments","ENGINE_URL","LOGIN_URL","location","hostname","includes","defaultContext","token","address","user","isAuthenticating","connect","disconnect","GrinderyLoginContext","createContext","GrinderyLoginProvider","children","loader","disconnectRedirectUrl","_useState","useState","setToken","_useState2","setUser","_useState3","setAddress","_useState4","setIsAuthenticating","_React$useState","React","loading","setLoading","_ref2","currentUrl","href","split","_ref3","_callee2","_iframe$contentWindow","iframe","_callee2$","_context2","document","getElementById","contentWindow","postMessage","method","identifyUser","useCallback","_callee3","rawResponse","getUserEmailResponse","_callee3$","_context3","access_token","fetch","headers","Authorization","Accept","body","JSON","stringify","jsonrpc","Date","params","sent","json","result","Error","t0","console","error","useEffect","handleMessage","event","_event$data","data","_event$data2","_event$data4","_event$data5","_event$data6","_event$data3","log","addEventListener","removeEventListener","setTimeout","Provider","value","title","src","style","display","useGrinderyLogin","useContext"],"mappings":"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"}